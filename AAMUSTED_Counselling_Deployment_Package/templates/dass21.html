{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">DASS-21 Assessment Score Entry</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('dass21') }}" class="needs-validation" novalidate>
                        <!-- Student Selection -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="student_id" class="form-label">Student <span class="text-danger">*</span></label>
                                <select class="form-select" id="student_id" name="student_id" required>
                                    <option value="">Choose student...</option>
                                    {% for student in students %}
                                    <option value="{{ student.id }}">{{ student.name }} - {{ student.programme }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    Please select a student.
                                </div>
                            </div>
                        </div>

                        <!-- DASS-21 Scores -->
                        <div class="row g-3">
                            <!-- Depression Score -->
                            <div class="col-md-4">
                                <label for="depression_score" class="form-label">Depression Score <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="depression_score" name="depression_score"
                                       min="0" max="21" step="0.5" required>
                                <div class="invalid-feedback">
                                    Please enter a valid score (0-21).
                                </div>
                                <div id="depression_severity" class="form-text mt-2"></div>
                            </div>

                            <!-- Anxiety Score -->
                            <div class="col-md-4">
                                <label for="anxiety_score" class="form-label">Anxiety Score <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="anxiety_score" name="anxiety_score"
                                       min="0" max="21" step="0.5" required>
                                <div class="invalid-feedback">
                                    Please enter a valid score (0-21).
                                </div>
                                <div id="anxiety_severity" class="form-text mt-2"></div>
                            </div>

                            <!-- Stress Score -->
                            <div class="col-md-4">
                                <label for="stress_score" class="form-label">Stress Score <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="stress_score" name="stress_score"
                                       min="0" max="21" step="0.5" required>
                                <div class="invalid-feedback">
                                    Please enter a valid score (0-21).
                                </div>
                                <div id="stress_severity" class="form-text mt-2"></div>
                            </div>
                        </div>

                        <!-- Final Scores Display -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">Final Scores (×2):</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            Depression: <span id="final_depression">0</span>
                                        </div>
                                        <div class="col-md-4">
                                            Anxiety: <span id="final_anxiety">0</span>
                                        </div>
                                        <div class="col-md-4">
                                            Stress: <span id="final_stress">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-save"></i> Save Scores
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- DASS-21 Guidelines -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">DASS-21 Interpretation Guidelines</h5>
                </div>
                <div class="card-body">
                    <!-- Severity Ratings Tables -->
                    <div class="row">
                        <!-- Depression -->
                        <div class="col-md-4">
                            <h6 class="border-bottom pb-2">Depression Severity</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Score</th>
                                            <th>Severity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>0-9</td><td>Normal</td></tr>
                                        <tr><td>10-13</td><td>Mild</td></tr>
                                        <tr><td>14-20</td><td>Moderate</td></tr>
                                        <tr><td>21-27</td><td>Severe</td></tr>
                                        <tr><td>28+</td><td>Extremely Severe</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Anxiety -->
                        <div class="col-md-4">
                            <h6 class="border-bottom pb-2">Anxiety Severity</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Score</th>
                                            <th>Severity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>0-7</td><td>Normal</td></tr>
                                        <tr><td>8-9</td><td>Mild</td></tr>
                                        <tr><td>10-14</td><td>Moderate</td></tr>
                                        <tr><td>15-19</td><td>Severe</td></tr>
                                        <tr><td>20+</td><td>Extremely Severe</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Stress -->
                        <div class="col-md-4">
                            <h6 class="border-bottom pb-2">Stress Severity</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Score</th>
                                            <th>Severity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>0-14</td><td>Normal</td></tr>
                                        <tr><td>15-18</td><td>Mild</td></tr>
                                        <tr><td>19-25</td><td>Moderate</td></tr>
                                        <tr><td>26-33</td><td>Severe</td></tr>
                                        <tr><td>34+</td><td>Extremely Severe</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Important Notes -->
                    <div class="alert alert-warning mt-4 mb-0">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Important Notes:</h6>
                        <ul class="mb-0">
                            <li>Enter the raw scores (0-21) for each category.</li>
                            <li>Final scores will be automatically multiplied by 2.</li>
                            <li>Keep the original DASS-21 questionnaire for detailed reference.</li>
                            <li>Consider referral for severe or extremely severe scores.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Score calculation and severity display
    function updateScores() {
        const scores = {
            depression: parseFloat(document.getElementById('depression_score').value) || 0,
            anxiety: parseFloat(document.getElementById('anxiety_score').value) || 0,
            stress: parseFloat(document.getElementById('stress_score').value) || 0
        }

        // Update final scores (×2)
        document.getElementById('final_depression').textContent = (scores.depression * 2).toFixed(1)
        document.getElementById('final_anxiety').textContent = (scores.anxiety * 2).toFixed(1)
        document.getElementById('final_stress').textContent = (scores.stress * 2).toFixed(1)

        // Update severity indicators
        updateSeverity('depression', scores.depression * 2)
        updateSeverity('anxiety', scores.anxiety * 2)
        updateSeverity('stress', scores.stress * 2)
    }

    function updateSeverity(type, score) {
        let severity = ''
        let color = ''

        if (type === 'depression') {
            if (score <= 9) { severity = 'Normal'; color = 'success' }
            else if (score <= 13) { severity = 'Mild'; color = 'info' }
            else if (score <= 20) { severity = 'Moderate'; color = 'warning' }
            else if (score <= 27) { severity = 'Severe'; color = 'danger' }
            else { severity = 'Extremely Severe'; color = 'danger' }
        } else if (type === 'anxiety') {
            if (score <= 7) { severity = 'Normal'; color = 'success' }
            else if (score <= 9) { severity = 'Mild'; color = 'info' }
            else if (score <= 14) { severity = 'Moderate'; color = 'warning' }
            else if (score <= 19) { severity = 'Severe'; color = 'danger' }
            else { severity = 'Extremely Severe'; color = 'danger' }
        } else if (type === 'stress') {
            if (score <= 14) { severity = 'Normal'; color = 'success' }
            else if (score <= 18) { severity = 'Mild'; color = 'info' }
            else if (score <= 25) { severity = 'Moderate'; color = 'warning' }
            else if (score <= 33) { severity = 'Severe'; color = 'danger' }
            else { severity = 'Extremely Severe'; color = 'danger' }
        }

        document.getElementById(`${type}_severity`).innerHTML = 
            `<span class="badge bg-${color}">${severity}</span>`
    }

    // Add event listeners to score inputs
    document.getElementById('depression_score').addEventListener('input', updateScores)
    document.getElementById('anxiety_score').addEventListener('input', updateScores)
    document.getElementById('stress_score').addEventListener('input', updateScores)

    // Validate score ranges
    function validateScore(input) {
        const value = parseFloat(input.value)
        if (value < 0 || value > 21) {
            input.setCustomValidity('Score must be between 0 and 21')
        } else {
            input.setCustomValidity('')
        }
    }

    document.getElementById('depression_score').addEventListener('input', function() {
        validateScore(this)
    })
    document.getElementById('anxiety_score').addEventListener('input', function() {
        validateScore(this)
    })
    document.getElementById('stress_score').addEventListener('input', function() {
        validateScore(this)
    })
</script>
{% endblock %}