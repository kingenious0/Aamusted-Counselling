{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Referral Form</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('referral') }}" class="needs-validation" novalidate>
                        <!-- session Selection -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="session_id" class="form-label">Select session <span class="text-danger">*</span></label>
                                <select class="form-select" id="session_id" name="session_id" required>
                                    <option value="">Choose session...</option>
                                    {% for session in sessions %}
                                    <option value="{{ session.id }}">
                                        {{ session.created_at.split('.')[0] }} - {{ session.student_name }} ({{ session.index_number }}) - {{ session.Counsellor_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    Please select a session.
                                </div>
                            </div>
                        </div>

                        <!-- Referral Details -->
                        <div class="row g-3">
                            <!-- Referred By -->
                            <div class="col-md-6">
                                <label for="referred_by" class="form-label">Referred By <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="referred_by" name="referred_by" required
                                       placeholder="Name of referring person/department">
                                <div class="invalid-feedback">
                                    Please provide who made the referral.
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div class="col-md-6">
                                <label for="contact" class="form-label">Contact Information <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="contact" name="contact" required
                                       placeholder="Phone number or email">
                                <div class="invalid-feedback">
                                    Please provide contact information.
                                </div>
                            </div>

                            <!-- Reasons for Referral -->
                            <div class="col-12">
                                <label class="form-label">Reason(s) for Referral <span class="text-danger">*</span></label>
                                <div class="border rounded p-3 bg-light" style="min-height: 200px;">
                                    <div class="row g-2">
                                        <!-- Column 1 -->
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Motivation" id="reason_motivation">
                                                <label class="form-check-label" for="reason_motivation">Motivation</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Bullying" id="reason_bullying">
                                                <label class="form-check-label" for="reason_bullying">Bullying</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Divorce" id="reason_divorce">
                                                <label class="form-check-label" for="reason_divorce">Divorce</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Homelessness" id="reason_homelessness">
                                                <label class="form-check-label" for="reason_homelessness">Homelessness</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Worries" id="reason_worries">
                                                <label class="form-check-label" for="reason_worries">Worries</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Stressed" id="reason_stressed">
                                                <label class="form-check-label" for="reason_stressed">Stressed</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Friendship" id="reason_friendship">
                                                <label class="form-check-label" for="reason_friendship">Friendship</label>
                                            </div>
                                        </div>
                                        <!-- Column 2 -->
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Problems" id="reason_problems">
                                                <label class="form-check-label" for="reason_problems">Problems</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Social Skills" id="reason_social_skills">
                                                <label class="form-check-label" for="reason_social_skills">Social Skills</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Inattentive" id="reason_inattentive">
                                                <label class="form-check-label" for="reason_inattentive">Inattentive</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Hyperactive" id="reason_hyperactive">
                                                <label class="form-check-label" for="reason_hyperactive">Hyperactive</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Sexual Activity" id="reason_sexual_activity">
                                                <label class="form-check-label" for="reason_sexual_activity">Sexual Activity</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Personal Hygiene" id="reason_personal_hygiene">
                                                <label class="form-check-label" for="reason_personal_hygiene">Personal Hygiene</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Pregnancy" id="reason_pregnancy">
                                                <label class="form-check-label" for="reason_pregnancy">Pregnancy</label>
                                            </div>
                                        </div>
                                        <!-- Column 3 -->
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Abuse" id="reason_abuse">
                                                <label class="form-check-label" for="reason_abuse">Abuse</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Self Cutting" id="reason_self_cutting">
                                                <label class="form-check-label" for="reason_self_cutting">Self Cutting</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Withdrawn" id="reason_withdrawn">
                                                <label class="form-check-label" for="reason_withdrawn">Withdrawn</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Stealing" id="reason_stealing">
                                                <label class="form-check-label" for="reason_stealing">Stealing</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Depression" id="reason_depression">
                                                <label class="form-check-label" for="reason_depression">Depression</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Perfectionism" id="reason_perfectionism">
                                                <label class="form-check-label" for="reason_perfectionism">Perfectionism</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Neglect" id="reason_neglect">
                                                <label class="form-check-label" for="reason_neglect">Neglect</label>
                                            </div>
                                        </div>
                                        <!-- Column 4 -->
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Anger" id="reason_anger">
                                                <label class="form-check-label" for="reason_anger">Anger</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Sadness" id="reason_sadness">
                                                <label class="form-check-label" for="reason_sadness">Sadness</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Grief" id="reason_grief">
                                                <label class="form-check-label" for="reason_grief">Grief</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Fears" id="reason_fears">
                                                <label class="form-check-label" for="reason_fears">Fears</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Lacking basic essentials" id="reason_basic_essentials">
                                                <label class="form-check-label" for="reason_basic_essentials">Lacking basic essentials</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Drug/Alcohol Use" id="reason_drug_alcohol">
                                                <label class="form-check-label" for="reason_drug_alcohol">Drug/Alcohol Use</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Lying/Dishonesty" id="reason_lying">
                                                <label class="form-check-label" for="reason_lying">Lying/Dishonesty</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="referral_reasons" value="Something Else" id="reason_something_else" onchange="toggleOtherReason(this)">
                                                <label class="form-check-label" for="reason_something_else">Something Else</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Something Else Text Input -->
                                    <div class="row mt-3" id="other_reason_container" style="display: none;">
                                        <div class="col-12">
                                            <label for="other_reason_text" class="form-label">Please specify:</label>
                                            <input type="text" class="form-control" id="other_reason_text" name="other_reason_text" placeholder="Enter other reason...">
                                        </div>
                                    </div>
                                </div>
                                <div class="invalid-feedback" id="reasons_feedback" style="display: none;">
                                    Please select at least one reason for the referral.
                                </div>
                            </div>

                            <!-- Action Taken -->
                            <div class="col-12">
                                <label for="action_taken" class="form-label">Action Taken</label>
                                <textarea class="form-control" id="action_taken" name="action_taken" rows="3"
                                          placeholder="Describe actions taken..."></textarea>
                            </div>

                            <!-- Outcome -->
                            <div class="col-12">
                                <label for="outcome" class="form-label">Outcome</label>
                                <textarea class="form-control" id="outcome" name="outcome" rows="3"
                                          placeholder="Describe the outcome of the referral..."></textarea>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-info text-white">
                                    <i class="bi bi-send"></i> Submit Referral
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Referral Guidelines -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">Referral Guidelines</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- When to Refer -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-question-circle"></i> When to Refer</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-check2"></i> Severe mental health concerns</li>
                                        <li><i class="bi bi-check2"></i> Need for specialized treatment</li>
                                        <li><i class="bi bi-check2"></i> Academic performance issues</li>
                                        <li><i class="bi bi-check2"></i> Financial or legal concerns</li>
                                        <li><i class="bi bi-check2"></i> Medical conditions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Referral Resources -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-building"></i> Common Referral Resources</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-hospital"></i> Mental Health Services</li>
                                        <li><i class="bi bi-book"></i> Academic Support Services</li>
                                        <li><i class="bi bi-cash"></i> Financial Aid Office</li>
                                        <li><i class="bi bi-briefcase"></i> Career Services</li>
                                        <li><i class="bi bi-heart"></i> Health Services</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Important Notes -->
                    <div class="alert alert-warning mt-3 mb-0">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Important Notes:</h6>
                        <ul class="mb-0">
                            <li>Always obtain student's consent before making referrals</li>
                            <li>Provide clear information about the referral process</li>
                            <li>Follow up with the student after making referrals</li>
                            <li>Document all referral communications</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Toggle "Something Else" text input
    function toggleOtherReason(checkbox) {
        const container = document.getElementById('other_reason_container');
        const textInput = document.getElementById('other_reason_text');
        if (checkbox.checked) {
            container.style.display = 'block';
            textInput.required = true;
        } else {
            container.style.display = 'none';
            textInput.required = false;
            textInput.value = '';
        }
    }
    
    // Validate that at least one reason is selected before form submission
    document.querySelector('form.needs-validation').addEventListener('submit', function(e) {
        const checkedReasons = document.querySelectorAll('input[name="referral_reasons"]:checked');
        if (checkedReasons.length === 0) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('reasons_feedback').style.display = 'block';
            return false;
        }
        
        // Check if "Something Else" is checked but no text provided
        const somethingElseChecked = document.getElementById('reason_something_else').checked;
        const otherReasonText = document.getElementById('other_reason_text').value.trim();
        if (somethingElseChecked && !otherReasonText) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('other_reason_text').focus();
            alert('Please specify the "Something Else" reason or uncheck the option.');
            return false;
        }
    });
</script>
{% endblock %}