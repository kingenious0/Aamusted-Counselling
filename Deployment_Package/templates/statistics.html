{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="bi bi-bar-chart-fill me-2"></i>System Statistics</h2>
                    <p class="text-muted mb-0">Comprehensive analytics and insights about your counselling system</p>
                </div>
                <button onclick="window.print()" class="btn btn-outline-primary">
                    <i class="bi bi-printer me-2"></i>Print Report
                </button>
            </div>
        </div>
    </div>

    <!-- Overall Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card-overview stat-card-blue">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Students</h6>
                            <h2 class="mb-0">{{ stats_data.overall.total_students }}</h2>
                        </div>
                        <div class="stat-icon-large bg-blue">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card-overview stat-card-green">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Appointments</h6>
                            <h2 class="mb-0">{{ stats_data.overall.total_appointments }}</h2>
                        </div>
                        <div class="stat-icon-large bg-green">
                            <i class="bi bi-calendar-check-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card-overview stat-card-purple">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Sessions</h6>
                            <h2 class="mb-0">{{ stats_data.overall.total_sessions }}</h2>
                        </div>
                        <div class="stat-icon-large bg-purple">
                            <i class="bi bi-clipboard-heart-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card-overview stat-card-orange">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Referrals</h6>
                            <h2 class="mb-0">{{ stats_data.overall.total_referrals }}</h2>
                        </div>
                        <div class="stat-icon-large bg-orange">
                            <i class="bi bi-arrow-right-circle-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Students by Gender -->
        <div class="col-lg-6">
            <div class="card chart-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Students by Gender</h5>
                </div>
                <div class="card-body">
                    <canvas id="genderChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Students by Programme -->
        <div class="col-lg-6">
            <div class="card chart-card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Students by Programme</h5>
                </div>
                <div class="card-body">
                    <canvas id="programmeChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Students by Department -->
        <div class="col-lg-6">
            <div class="card chart-card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-building me-2"></i>Students by Department</h5>
                </div>
                <div class="card-body">
                    <canvas id="departmentChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Age Distribution -->
        <div class="col-lg-6">
            <div class="card chart-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up me-2"></i>Age Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="ageChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Appointments by Status -->
        <div class="col-lg-6">
            <div class="card chart-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-pie-chart me-2"></i>Appointments by Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="appointmentStatusChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Sessions by Type -->
        <div class="col-lg-6">
            <div class="card chart-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-list-check me-2"></i>Sessions by Type</h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionTypeChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Appointments Over Time -->
        <div class="col-lg-12">
            <div class="card chart-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Appointments Over Time (Last 6 Months)</h5>
                </div>
                <div class="card-body">
                    <canvas id="appointmentTimelineChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Sessions Over Time -->
        <div class="col-lg-12">
            <div class="card chart-card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up me-2"></i>Sessions Over Time (Last 6 Months)</h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionTimelineChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- New Students Over Time -->
        <div class="col-lg-12">
            <div class="card chart-card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-people me-2"></i>New Students Over Time (Last 6 Months)</h5>
                </div>
                <div class="card-body">
                    <canvas id="newStudentsChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Counsellors -->
        <div class="col-lg-12">
            <div class="card chart-card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-trophy me-2"></i>Top Counsellors by Appointments</h5>
                </div>
                <div class="card-body">
                    <canvas id="topCounsellorsChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card-overview {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        overflow: hidden;
    }

    .stat-card-overview:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .stat-card-blue { border-top: 4px solid #0d6efd; }
    .stat-card-green { border-top: 4px solid #198754; }
    .stat-card-purple { border-top: 4px solid #6f42c1; }
    .stat-card-orange { border-top: 4px solid #fd7e14; }

    .stat-icon-large {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        color: white;
    }

    .bg-blue { background: linear-gradient(135deg, #0d6efd, #0dcaf0); }
    .bg-green { background: linear-gradient(135deg, #198754, #20c997); }
    .bg-purple { background: linear-gradient(135deg, #6f42c1, #e83e8c); }
    .bg-orange { background: linear-gradient(135deg, #fd7e14, #ffc107); }

    .chart-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chart-card .card-header {
        border-radius: 12px 12px 0 0;
        border: none;
    }

    @media print {
        .btn { display: none !important; }
        .chart-card { page-break-inside: avoid; }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
<script>
    // Chart.js configuration
    Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
    Chart.defaults.plugins.legend.position = 'bottom';
    Chart.defaults.plugins.legend.labels.boxWidth = 12;

    const statsData = {{ stats_data | tojson }};

    // Gender Chart (Pie)
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    new Chart(genderCtx, {
        type: 'pie',
        data: {
            labels: statsData.gender.map(item => item.gender),
            datasets: [{
                data: statsData.gender.map(item => item.count),
                backgroundColor: [
                    '#0d6efd', '#e83e8c', '#6f42c1', '#20c997', '#fd7e14', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Programme Chart (Bar)
    const programmeCtx = document.getElementById('programmeChart').getContext('2d');
    new Chart(programmeCtx, {
        type: 'bar',
        data: {
            labels: statsData.programme.map(item => item.programme.length > 20 ? item.programme.substring(0, 20) + '...' : item.programme),
            datasets: [{
                label: 'Students',
                data: statsData.programme.map(item => item.count),
                backgroundColor: '#198754',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { ticks: { maxRotation: 45, minRotation: 45 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Department Chart (Bar)
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    new Chart(departmentCtx, {
        type: 'bar',
        data: {
            labels: statsData.department.map(item => item.department.length > 15 ? item.department.substring(0, 15) + '...' : item.department),
            datasets: [{
                label: 'Students',
                data: statsData.department.map(item => item.count),
                backgroundColor: '#0dcaf0',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Age Distribution Chart (Bar)
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    new Chart(ageCtx, {
        type: 'bar',
        data: {
            labels: statsData.age_distribution.map(item => item.age_group),
            datasets: [{
                label: 'Students',
                data: statsData.age_distribution.map(item => item.count),
                backgroundColor: '#ffc107',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Appointment Status Chart (Doughnut)
    const appointmentStatusCtx = document.getElementById('appointmentStatusChart').getContext('2d');
    new Chart(appointmentStatusCtx, {
        type: 'doughnut',
        data: {
            labels: statsData.appointment_status.map(item => item.status),
            datasets: [{
                data: statsData.appointment_status.map(item => item.count),
                backgroundColor: [
                    '#0d6efd', '#ffc107', '#198754', '#dc3545', '#6c757d', '#0dcaf0'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Session Type Chart (Horizontal Bar)
    if (statsData.session_type && statsData.session_type.length > 0) {
        const sessionTypeCtx = document.getElementById('sessionTypeChart').getContext('2d');
        new Chart(sessionTypeCtx, {
            type: 'bar',
            data: {
                labels: statsData.session_type.map(item => item.session_type || 'Not Specified'),
                datasets: [{
                    label: 'Sessions',
                    data: statsData.session_type.map(item => item.count),
                    backgroundColor: '#6c757d',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Appointments Timeline Chart (Line)
    const appointmentTimelineCtx = document.getElementById('appointmentTimelineChart').getContext('2d');
    new Chart(appointmentTimelineCtx, {
        type: 'line',
        data: {
            labels: statsData.appointment_timeline.map(item => item.month),
            datasets: [{
                label: 'Appointments',
                data: statsData.appointment_timeline.map(item => item.count),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Sessions Timeline Chart (Line)
    const sessionTimelineCtx = document.getElementById('sessionTimelineChart').getContext('2d');
    new Chart(sessionTimelineCtx, {
        type: 'line',
        data: {
            labels: statsData.session_timeline.map(item => item.month),
            datasets: [{
                label: 'Sessions',
                data: statsData.session_timeline.map(item => item.count),
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // New Students Timeline Chart (Line)
    const newStudentsCtx = document.getElementById('newStudentsChart').getContext('2d');
    new Chart(newStudentsCtx, {
        type: 'line',
        data: {
            labels: statsData.new_students_timeline.map(item => item.month),
            datasets: [{
                label: 'New Students',
                data: statsData.new_students_timeline.map(item => item.count),
                borderColor: '#0dcaf0',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Top Counsellors Chart (Bar)
    if (statsData.top_counsellors && statsData.top_counsellors.length > 0) {
        const topCounsellorsCtx = document.getElementById('topCounsellorsChart').getContext('2d');
        new Chart(topCounsellorsCtx, {
            type: 'bar',
            data: {
                labels: statsData.top_counsellors.map(item => item.name),
                datasets: [{
                    label: 'Appointments',
                    data: statsData.top_counsellors.map(item => item.count),
                    backgroundColor: '#212529',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
</script>
{% endblock %}

