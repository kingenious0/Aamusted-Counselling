{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Outcome Questionnaire Score Entry</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('outcome_questionnaire') }}" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <!-- Student Selection -->
                            <div class="col-md-12">
                                <label for="student_id" class="form-label">Student <span class="text-danger">*</span></label>
                                <select class="form-select" id="student_id" name="student_id" required>
                                    <option value="">Choose student...</option>
                                    {% for student in students %}
                                    <option value="{{ student.id }}">{{ student.name }} - {{ student.programme }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    Please select a student.
                                </div>
                            </div>

                            <!-- session Selection -->
                            <div class="col-md-12">
                                <label for="session_id" class="form-label">Related session <span class="text-danger">*</span></label>
                                <select class="form-select" id="session_id" name="session_id" required>
                                    <option value="">Choose session...</option>
                                    {% for s in sessions %}
                                    <option value="{{ s.id }}">
                                        {{ s.created_at_formatted }} - {{ s.student_name }} ({{ s.professional_id }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    Please select a session.
                                </div>
                            </div>

                            <!-- Age -->
                            <div class="col-md-6">
                                <label for="age" class="form-label">Age</label>
                                <input type="number" class="form-control" id="age" name="age" min="0">
                            </div>

                            <!-- Sex -->
                            <div class="col-md-6">
                                <label for="sex" class="form-label">Sex</label>
                                <select class="form-select" id="sex" name="sex">
                                    <option value="">Select Sex</option>
                                    <option value="M">M</option>
                                    <option value="F">F</option>
                                </select>
                            </div>

                            <h5 class="mt-4">Items to Rate</h5>
                            <p>Please look below for items that describe the way you have felt during the last week, including today. Put an X in the box that describes how much you have experienced each feeling or thought.</p>
                            <p><strong>Frequency Ratings:</strong> 0 = Never, 1 = Rarely, 2 = Sometimes, 3 = Frequently, 4 = Almost Always</p>

                            {% for i in range(1, 26) %}
                            <div class="col-md-6">
                                <label for="item{{ i }}" class="form-label">Item {{ i }}</label>
                                <select class="form-select item-score" id="item{{ i }}" name="item{{ i }}">
                                    <option value="0">0 = Never</option>
                                    <option value="1">1 = Rarely</option>
                                    <option value="2">2 = Sometimes</option>
                                    <option value="3">3 = Frequently</option>
                                    <option value="4">4 = Almost Always</option>
                                </select>
                            </div>
                            {% endfor %}

                            <!-- Total Score -->
                            <div class="col-md-6">
                                <label for="total_score" class="form-label">Total Score <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="total_score" name="total_score"
                                       min="0" max="100" required readonly>
                                <div class="invalid-feedback">
                                    Please enter a valid score (0-100).
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Score
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Scoring Guidelines -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Outcome Questionnaire Guidelines</h5>
                </div>
                <div class="card-body">
                    <!-- Score Interpretation -->
                    <div class="mb-4">
                        <h6><i class="bi bi-graph-up"></i> Score Interpretation</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Score Range</th>
                                        <th>Interpretation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0-63</td>
                                        <td>Normal Range</td>
                                    </tr>
                                    <tr>
                                        <td>64-180</td>
                                        <td>Clinical Range</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Important Notes -->
                    <div class="alert alert-info mb-0">
                        <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Important Notes:</h6>
                        <ul class="mb-0">
                            <li>Only enter the total score from the paper questionnaire.</li>
                            <li>Keep the original paper questionnaire for detailed reference.</li>
                            <li>Score changes of 14+ points are considered clinically significant.</li>
                            <li>Regular monitoring helps track progress over time.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Calculate total score dynamically
    const itemScoreSelects = document.querySelectorAll('.item-score');
    const totalScoreInput = document.getElementById('total_score');

    function calculateTotalScore() {
        let total = 0;
        itemScoreSelects.forEach(select => {
            total += parseInt(select.value);
        });
        totalScoreInput.value = total;
    }

    itemScoreSelects.forEach(select => {
        select.addEventListener('change', calculateTotalScore);
    });

    // Initial calculation on page load
    calculateTotalScore();

    // Filter session based on selected student
    document.getElementById('student_id').addEventListener('change', function(e) {
        const studentId = e.target.value;
        const sessionSelect = document.getElementById('session_id');
        const sessions = Array.from(sessionSelect.options);

        sessions.forEach(option => {
            if (option.value === '') return; // Keep the "Choose session..." option
            const studentNameInOption = option.text.split(' - ')[1]; // Assuming format "Date - StudentName"
            const selectedStudentName = e.target.selectedOptions[0].text.split(' - ')[0]; // Assuming format "StudentName - Programme"

            if (studentNameInOption && studentNameInOption.includes(selectedStudentName)) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });

        sessionSelect.value = ''; // Reset session selection
    });
</script>
{% endblock %}